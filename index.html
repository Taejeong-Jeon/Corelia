<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corelia - AI 핵심, 고급감</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- 좌측 GNB 메뉴 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="/Corelia/" class="logo-link" onclick="showSection('main'); updateURL(''); return false;">
                    <h1 class="logo">Corelia</h1>
                    <p class="logo-subtitle">Core + Intelligence</p>
                </a>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/Corelia/AI" class="nav-link" onclick="showSection('ai-tools'); toggleSubmenu('ai-tools'); updateURL('AI'); return false;">
                        <span class="nav-icon">🤖</span>
                        AI 활용하기
                        <span class="submenu-arrow">▼</span>
                    </a>
                    <ul class="submenu" id="ai-tools-submenu">
                        <li><a href="https://chatgpt.com/g/g-p-68a81e622c848191bfc6f52f5da56531-sosyeol/project" target="_blank">소설 만들기</a></li>
                        <li><a href="https://chatgpt.com/g/g-p-68da5f78b28c8191a99187e27d7add48-jemogbbobgi-jeongcaegboan-tstory/project" target="_blank">Tstory 블로그 제목 뽑기</a></li>
                        <li><a href="https://chatgpt.com/g/g-p-68da5e9cd36c8191b830e4f224cc3d13-naeyongmandeulgi-jeongcaegboan-tstory/project" target="_blank">Tstory 블로그 내용 만들기</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('ms'); toggleSubmenu('ms'); updateURL('MS'); return false;">
                        <span class="nav-icon">🎮</span>
                        MS
                        <span class="submenu-arrow">▼</span>
                    </a>
                    <ul class="submenu" id="ms-submenu">
                        <li><a href="#" onclick="showSection('ms-account'); updateURL('MS-ACCOUNT'); return false;">MS 가계부</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- 메인 콘텐츠 영역 -->
        <main class="main-content">
            <div class="content-header">
                <h2 id="page-title">Corelia</h2>
                <p id="page-subtitle">Core + Intelligence</p>
            </div>

            <!-- 메인 화면 -->
            <div class="content-body" id="main">
                <div class="main-welcome">
                    <div class="main-logo">
                        <h1>Corelia</h1>
                        <p>Core + Intelligence</p>
                    </div>
                </div>
            </div>

            <!-- AI 활용하기 화면 -->
            <div class="content-body hidden" id="ai-tools">
                <div class="ai-tools-grid">
                    <div class="tool-card">
                        <div class="tool-icon">📚</div>
                        <h4>소설 만들기</h4>
                        <p>창의적인 소설을 AI와 함께 만들어보세요</p>
                        <a href="https://chatgpt.com/g/g-p-68a81e622c848191bfc6f52f5da56531-sosyeol/project" target="_blank" class="tool-btn">시작하기</a>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">📝</div>
                        <h4>Tstory 블로그 제목 뽑기</h4>
                        <p>매력적인 블로그 제목을 AI가 제안해드립니다</p>
                        <a href="https://chatgpt.com/g/g-p-68da5f78b28c8191a99187e27d7add48-jemogbbobgi-jeongcaegboan-tstory/project" target="_blank" class="tool-btn">시작하기</a>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">✍️</div>
                        <h4>Tstory 블로그 내용 만들기</h4>
                        <p>고품질 블로그 콘텐츠를 AI와 함께 작성하세요</p>
                        <a href="https://chatgpt.com/g/g-p-68da5e9cd36c8191b830e4f224cc3d13-naeyongmandeulgi-jeongcaegboan-tstory/project" target="_blank" class="tool-btn">시작하기</a>
                    </div>
                </div>
            </div>

            <div class="content-body hidden" id="ms">
                <div class="welcome-section">
                    <h3>MS 섹션</h3>
                    <p>게임 관련 콘텐츠가 준비 중입니다</p>
                </div>
            </div>

            <!-- MS 홈 섹션 -->
            <div class="content-body hidden" id="ms">
                <div class="ai-tools-grid">
                    <div class="tool-card">
                        <div class="tool-icon">💰</div>
                        <h4>MS 가계부</h4>
                        <p>메이플스토리 수익과 지출을 관리하고 월별 통계를 확인하세요</p>
                        <button class="tool-btn" onclick="showSection('ms-account'); updateURL('MS-ACCOUNT'); return false;">시작하기</button>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">📊</div>
                        <h4>MS 통계</h4>
                        <p>메이플스토리 거래 통계와 수익 분석을 확인하세요</p>
                        <button class="tool-btn" onclick="alert('준비 중입니다!')">시작하기</button>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">🎯</div>
                        <h4>MS 목표</h4>
                        <p>수익 목표 설정과 달성 현황을 관리하세요</p>
                        <button class="tool-btn" onclick="alert('준비 중입니다!')">시작하기</button>
                    </div>
                </div>
            </div>

            <!-- MS 가계부 섹션 -->
            <div class="content-body hidden" id="ms-account">
                
                <!-- 연간 수익 그래프 -->
                <div class="annual-chart-section">
                    <h3>연간 수익 현황</h3>
                    <div class="chart-container">
                        <canvas id="annualChart" width="800" height="300"></canvas>
                    </div>
                </div>

                <!-- 월별 대시보드 -->
                <div class="dashboard-section">
                    <div class="month-selector">
                        <button onclick="changeMonth(-1)" class="month-btn">◀</button>
                        <h2 id="current-month">2025년 10월</h2>
                        <button onclick="changeMonth(1)" class="month-btn">▶</button>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="dashboard-card">
                            <h4>총 충전금액</h4>
                            <p id="total-charge">0원</p>
                        </div>
                        <div class="dashboard-card">
                            <h4>총 판매금액</h4>
                            <p id="total-sales">0원</p>
                        </div>
                        <div class="dashboard-card">
                            <h4>손익</h4>
                            <p id="profit-loss">0원</p>
                        </div>
                    </div>
                </div>

                <!-- 거래 입력 폼 -->
                <div class="form-section">
                    <h3>거래 입력</h3>
                    <form id="transaction-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>일자</label>
                                <input type="date" id="transaction-date" required>
                            </div>
                            <div class="form-group">
                                <label>거래 유형</label>
                                <select id="transaction-type" required onchange="toggleFields()">
                                    <option value="">선택하세요</option>
                                    <option value="charge">충전</option>
                                    <option value="convert">전환</option>
                                    <option value="sell">판매</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 충전 필드 -->
                        <div id="charge-fields" class="transaction-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>충전 금액 (원)</label>
                                    <input type="number" id="charge-amount" placeholder="예: 500000">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 전환 필드 -->
                        <div id="convert-fields" class="transaction-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>메포 시세 (원/1억)</label>
                                    <input type="number" id="mepo-rate" placeholder="예: 2500">
                                </div>
                                <div class="form-group">
                                    <label>구매한 메소 (억)</label>
                                    <input type="number" id="meso-amount" placeholder="예: 200" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 판매 필드 -->
                        <div id="sell-fields" class="transaction-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>물통 시세 (원/1억)</label>
                                    <input type="number" id="water-rate" placeholder="예: 2000">
                                </div>
                                <div class="form-group">
                                    <label>판매한 메소 (억)</label>
                                    <input type="number" id="sell-meso" placeholder="예: 200" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>메모</label>
                                <input type="text" id="memo" placeholder="선택사항">
                            </div>
                        </div>
                        <button type="submit" class="submit-btn">저장</button>
                    </form>
                </div>

                <!-- 거래 내역 -->
                <div class="transaction-list">
                    <h3>거래 내역</h3>
                    <div id="transaction-list-container">
                        <!-- 거래 내역이 여기에 리스트로 표시됩니다 -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // URL 업데이트 함수
        function updateURL(path) {
            // 로컬 파일인지 확인
            if (window.location.protocol === 'file:') {
                // 로컬에서는 hash 사용
                window.location.hash = path;
            } else {
                // 온라인에서는 path 사용
                const baseUrl = window.location.origin + '/Corelia/';
                const newUrl = baseUrl + path;
                window.history.pushState({path: path}, '', newUrl);
            }
        }

        // URL에서 섹션 읽기
        function getSectionFromURL() {
            // 로컬 파일인지 확인
            if (window.location.protocol === 'file:') {
                // 로컬에서는 hash 사용
                const hash = window.location.hash;
                if (hash === '#AI') return 'ai-tools';
                if (hash === '#MS') return 'ms';
                if (hash === '#MS-ACCOUNT') return 'ms-account';
                return 'main';
            } else {
                // 온라인에서는 path 사용
                const path = window.location.pathname;
                if (path.includes('/AI')) return 'ai-tools';
                if (path.includes('/MS-ACCOUNT')) return 'ms-account';
                if (path.includes('/MS')) return 'ms';
                return 'main';
            }
        }

        // 페이지 로드 시 URL에 따라 섹션 설정
        function initializePage() {
            const sectionId = getSectionFromURL();
            showSection(sectionId);
            
            // 네비게이션 활성화 상태 설정
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // 해당 섹션의 링크 활성화
            if (sectionId === 'ai-tools') {
                const aiLink = document.querySelector('a[href="/Corelia/AI"]');
                if (aiLink) {
                    aiLink.classList.add('active');
                    // AI 서브메뉴 열기
                    const submenu = document.getElementById('ai-tools-submenu');
                    const arrow = aiLink.querySelector('.submenu-arrow');
                    if (submenu && arrow) {
                        submenu.classList.add('active');
                        arrow.textContent = '▲';
                    }
                }
            } else if (sectionId === 'ms') {
                const msLink = document.querySelector('a[onclick*="ms"]');
                if (msLink) {
                    msLink.classList.add('active');
                    // MS 서브메뉴 열기
                    const submenu = document.getElementById('ms-submenu');
                    const arrow = msLink.querySelector('.submenu-arrow');
                    if (submenu && arrow) {
                        submenu.classList.add('active');
                        arrow.textContent = '▲';
                    }
                }
            } else if (sectionId === 'ms-account') {
                const msLink = document.querySelector('a[onclick*="ms"]');
                if (msLink) {
                    msLink.classList.add('active');
                    // MS 서브메뉴 열기
                    const submenu = document.getElementById('ms-submenu');
                    const arrow = msLink.querySelector('.submenu-arrow');
                    if (submenu && arrow) {
                        submenu.classList.add('active');
                        arrow.textContent = '▲';
                    }
                }
            }
        }

        function showSection(sectionId, event) {
            // 모든 섹션 숨기기
            const sections = document.querySelectorAll('.content-body');
            sections.forEach(section => section.classList.add('hidden'));
            
            // 선택된 섹션 보이기
            document.getElementById(sectionId).classList.remove('hidden');
            
            // 네비게이션 활성화 상태 업데이트
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // 현재 클릭된 링크 활성화 (event가 있을 때만)
            if (event && event.currentTarget && event.currentTarget.classList) {
                event.currentTarget.classList.add('active');
            }
            
            // 페이지 제목 업데이트
            const titles = {
                'main': { title: 'Corelia', subtitle: 'Core + Intelligence' },
                'ai-tools': { title: 'AI 활용하기', subtitle: 'Corelia의 AI 도구들을 활용해보세요' },
                'ms': { title: 'MS', subtitle: '게임 관련 콘텐츠가 준비 중입니다' },
                'ms-account': { title: 'MS 가계부', subtitle: '메이플스토리 수익 관리 시스템' }
            };
            
            document.getElementById('page-title').textContent = titles[sectionId].title;
            document.getElementById('page-subtitle').textContent = titles[sectionId].subtitle;
        }

        function toggleSubmenu(menuId) {
            const submenu = document.getElementById(menuId + '-submenu');
            const navLink = event.currentTarget;
            const arrow = navLink.querySelector('.submenu-arrow');
            
            if (submenu && arrow) {
                if (submenu.classList.contains('active')) {
                    submenu.classList.remove('active');
                    arrow.textContent = '▼';
                } else {
                    // 다른 서브메뉴들 닫기
                    document.querySelectorAll('.submenu').forEach(menu => {
                        menu.classList.remove('active');
                    });
                    document.querySelectorAll('.submenu-arrow').forEach(arrow => {
                        arrow.textContent = '▼';
                    });
                    
                    // 현재 서브메뉴 열기
                    submenu.classList.add('active');
                    arrow.textContent = '▲';
                }
            }
        }

        // 브라우저 뒤로가기/앞으로가기 처리
        window.addEventListener('popstate', function(event) {
            initializePage();
        });

        // hash 변경 처리 (로컬 파일용)
        window.addEventListener('hashchange', function(event) {
            initializePage();
        });

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 페이지 로드 시 로컬 스토리지에서 데이터 로드
            const localData = localStorage.getItem('ms-transactions');
            if (localData) {
                try {
                    transactions = JSON.parse(localData);
                    console.log('페이지 로드 시 로컬 데이터 로드:', transactions);
                } catch (error) {
                    console.error('로컬 데이터 파싱 실패:', error);
                    transactions = [];
                }
            }
            
            initializePage();
            initializeMSAccount();
        });

        // MS 가계부 관련 변수들
        let currentYear = 2025;
        let currentMonth = 10;
        let transactions = [];
        const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbx-sk4f9HHx-iXgCHeDhyt8HzHAKULQxA8akZx9VqJmGj6ZDkPNpgDcQ4FCr8FASlcP/exec';

        // 거래 유형에 따른 필드 표시/숨김
        function toggleFields() {
            const transactionType = document.getElementById('transaction-type').value;
            
            // 모든 필드 숨기기
            document.getElementById('charge-fields').style.display = 'none';
            document.getElementById('convert-fields').style.display = 'none';
            document.getElementById('sell-fields').style.display = 'none';
            
            // 선택된 유형에 따라 필드 표시
            if (transactionType === 'charge') {
                document.getElementById('charge-fields').style.display = 'block';
                document.getElementById('charge-amount').required = true;
            } else if (transactionType === 'convert') {
                document.getElementById('convert-fields').style.display = 'block';
                document.getElementById('mepo-rate').required = true;
                document.getElementById('meso-amount').required = true;
            } else if (transactionType === 'sell') {
                document.getElementById('sell-fields').style.display = 'block';
                document.getElementById('water-rate').required = true;
                document.getElementById('sell-meso').required = true;
            }
            
            // 다른 필드들의 required 해제
            document.getElementById('charge-amount').required = false;
            document.getElementById('mepo-rate').required = false;
            document.getElementById('meso-amount').required = false;
            document.getElementById('water-rate').required = false;
            document.getElementById('sell-meso').required = false;
        }

        // 연간 수익 그래프 그리기
        function drawAnnualChart() {
            const canvas = document.getElementById('annualChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // 캔버스 초기화
            ctx.clearRect(0, 0, width, height);
            
            // 연간 데이터 계산
            const currentYear = new Date().getFullYear();
            const monthlyData = [];
            
            for (let month = 1; month <= 12; month++) {
                const monthTransactions = transactions.filter(t => {
                    const date = new Date(t.date);
                    return date.getFullYear() === currentYear && date.getMonth() + 1 === month;
                });
                
                const totalCharge = monthTransactions
                    .filter(t => t.type === 'charge')
                    .reduce((sum, t) => sum + (parseInt(t.chargeAmount) || 0), 0);
                
                const totalSales = monthTransactions
                    .filter(t => t.type === 'sell')
                    .reduce((sum, t) => sum + (parseInt(t.salesAmount) || 0), 0);
                
                const profitLoss = totalSales - totalCharge;
                monthlyData.push(profitLoss);
            }
            
            // 그래프 그리기
            const margin = 60;
            const chartWidth = width - 2 * margin;
            const chartHeight = height - 2 * margin;
            
            // 배경 그리기
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(margin, margin, chartWidth, chartHeight);
            
            // 격자 그리기
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 1;
            
            // 수평 격자
            for (let i = 0; i <= 10; i++) {
                const y = margin + (chartHeight / 10) * i;
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(margin + chartWidth, y);
                ctx.stroke();
            }
            
            // 수직 격자
            for (let i = 0; i <= 12; i++) {
                const x = margin + (chartWidth / 12) * i;
                ctx.beginPath();
                ctx.moveTo(x, margin);
                ctx.lineTo(x, margin + chartHeight);
                ctx.stroke();
            }
            
            // 0선 그리기
            const zeroY = margin + chartHeight / 2;
            ctx.strokeStyle = '#6c757d';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, zeroY);
            ctx.lineTo(margin + chartWidth, zeroY);
            ctx.stroke();
            
            // 데이터 포인트 그리기
            const maxValue = Math.max(...monthlyData.map(Math.abs));
            const scale = maxValue > 0 ? (chartHeight / 2) / maxValue : 1;
            
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            monthlyData.forEach((value, index) => {
                const x = margin + (chartWidth / 12) * (index + 0.5);
                const y = zeroY - (value * scale);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // 포인트 그리기
                ctx.fillStyle = value >= 0 ? '#28a745' : '#dc3545';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            ctx.stroke();
            
            // 월 라벨 그리기
            ctx.fillStyle = '#6c757d';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            for (let i = 0; i < 12; i++) {
                const x = margin + (chartWidth / 12) * (i + 0.5);
                const y = height - 20;
                ctx.fillText(`${i + 1}월`, x, y);
            }
            
            // Y축 라벨 그리기
            ctx.textAlign = 'right';
            ctx.fillText('수익', 20, margin + 10);
            ctx.fillText('손실', 20, height - margin - 10);
        }

        // MS 가계부 초기화
        function initializeMSAccount() {
            // 오늘 날짜를 기본값으로 설정
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            
            // 폼 제출 이벤트 리스너
            document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);
            
            // 먼저 로컬 스토리지에서 데이터 로드
            const localData = localStorage.getItem('ms-transactions');
            if (localData) {
                try {
                    transactions = JSON.parse(localData);
                    console.log('로컬 데이터 로드 성공:', transactions);
                    updateDashboard();
                } catch (error) {
                    console.error('로컬 데이터 파싱 실패:', error);
                    transactions = [];
                }
            }
            
            // Google Sheets에서 데이터 로드 시도
            loadTransactions();
        }

        // Google Sheets에서 거래 데이터 로드
        async function loadTransactions() {
            try {
                console.log('데이터 로드 시작...');
                const response = await fetch(GOOGLE_SHEETS_API_URL);
                console.log('응답 상태:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('로드된 데이터:', data);
                
                // Google Sheets에 데이터가 있으면 사용, 없으면 로컬 데이터 유지
                if (data && data.length > 0) {
                    transactions = data;
                    console.log('Google Sheets 데이터 사용:', transactions);
                } else {
                    console.log('Google Sheets가 비어있음, 로컬 데이터 유지');
                }
                updateDashboard();
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                // 로컬 스토리지에서 데이터 로드 시도
                const localData = localStorage.getItem('ms-transactions');
                if (localData) {
                    transactions = JSON.parse(localData);
                    console.log('로컬 데이터 로드:', transactions);
                }
                updateDashboard();
            }
        }

        // Google Sheets에 거래 데이터 저장
        async function saveTransaction(transaction) {
            try {
                console.log('데이터 저장 시작:', transaction);
                
                const response = await fetch(GOOGLE_SHEETS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transaction)
                });
                
                console.log('저장 응답 상태:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('저장 결과:', result);
                
                if (result.success) {
                    console.log('Google Sheets 저장 성공');
                    // 데이터 다시 로드
                    await loadTransactions();
                } else {
                    throw new Error('저장 실패');
                }
            } catch (error) {
                console.error('Google Sheets 저장 실패:', error);
                console.log('로컬 저장으로 대체...');
                
                // 로컬에 저장 (백업)
                const newTransaction = {
                    ...transaction,
                    id: Date.now().toString()
                };
                transactions.push(newTransaction);
                
                // 로컬 스토리지에도 저장
                localStorage.setItem('ms-transactions', JSON.stringify(transactions));
                
                updateDashboard();
                alert('데이터가 로컬에 저장되었습니다. (Google Sheets 연결 실패)');
            }
        }

        // 월 변경 함수
        function changeMonth(direction) {
            currentMonth += direction;
            
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            // 2030년 12월 제한
            if (currentYear > 2030 || (currentYear === 2030 && currentMonth > 12)) {
                currentYear = 2030;
                currentMonth = 12;
            }
            
            // 2025년 10월 제한
            if (currentYear < 2025 || (currentYear === 2025 && currentMonth < 10)) {
                currentYear = 2025;
                currentMonth = 10;
            }
            
            updateMonthDisplay();
            updateDashboard();
        }

        // 월 표시 업데이트
        function updateMonthDisplay() {
            document.getElementById('current-month').textContent = `${currentYear}년 ${currentMonth}월`;
        }

        // 대시보드 업데이트
        function updateDashboard() {
            const monthTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === currentYear && date.getMonth() + 1 === currentMonth;
            });
            
            // 충전 총액 (지출이므로 마이너스)
            const totalCharge = monthTransactions
                .filter(t => t.type === 'charge')
                .reduce((sum, t) => sum + (parseInt(t.chargeAmount) || 0), 0);
            
            // 판매 총 금액 (수입이므로 플러스)
            const totalSales = monthTransactions
                .filter(t => t.type === 'sell')
                .reduce((sum, t) => sum + (parseInt(t.salesAmount) || 0), 0);
            
            // 손익 계산: 판매금액(+) - 충전금액(-)
            // 전환은 메소 구매/보관이므로 손익에 영향 없음
            const profitLoss = totalSales - totalCharge;
            
            document.getElementById('total-charge').textContent = `${totalCharge.toLocaleString()}원`;
            document.getElementById('total-sales').textContent = `${totalSales.toLocaleString()}원`;
            
            const profitLossElement = document.getElementById('profit-loss');
            profitLossElement.textContent = `${profitLoss.toLocaleString()}원`;
            
            // 손익에 따른 색상 변경
            if (profitLoss > 0) {
                profitLossElement.style.color = '#007bff'; // 파란색 (수익)
            } else if (profitLoss < 0) {
                profitLossElement.style.color = '#dc3545'; // 빨간색 (손해)
            } else {
                profitLossElement.style.color = '#6c757d'; // 회색 (손익 없음)
            }
            
            updateTransactionTable();
            drawAnnualChart();
        }

        // 거래 제출 처리
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            
            const transactionType = document.getElementById('transaction-type').value;
            const date = document.getElementById('transaction-date').value;
            const memo = document.getElementById('memo').value || '';
            
            let transaction = {
                id: Date.now().toString(),
                date: date,
                type: transactionType,
                memo: memo
            };
            
            if (transactionType === 'charge') {
                // 충전: 일자 + 충전금액만
                transaction.chargeAmount = parseInt(document.getElementById('charge-amount').value);
                
            } else if (transactionType === 'convert') {
                // 전환: 메포시세 + 구매한 메소
                transaction.mepoRate = parseInt(document.getElementById('mepo-rate').value);
                transaction.mesoAmount = parseFloat(document.getElementById('meso-amount').value);
                transaction.convertCost = transaction.mepoRate * transaction.mesoAmount; // 전환 비용
                
            } else if (transactionType === 'sell') {
                // 판매: 물통시세 + 판매한 메소
                transaction.waterRate = parseInt(document.getElementById('water-rate').value);
                transaction.sellMeso = parseFloat(document.getElementById('sell-meso').value);
                transaction.salesAmount = transaction.waterRate * transaction.sellMeso; // 판매 금액
            }
            
            // Google Sheets에 저장 시도 (실패 시 로컬에 저장)
            await saveTransaction(transaction);
            
            // 폼 초기화
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
        }

        // 거래 리스트 업데이트
        function updateTransactionTable() {
            const container = document.getElementById('transaction-list-container');
            container.innerHTML = '';
            
            const monthTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === currentYear && date.getMonth() + 1 === currentMonth;
            });
            
            if (monthTransactions.length === 0) {
                container.innerHTML = '<div class="empty-state">이번 달 거래 내역이 없습니다.</div>';
                return;
            }
            
            monthTransactions.forEach(transaction => {
                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item';
                
                let typeIcon, typeText, amountText, rateText, resultText, resultColor;
                
                if (transaction.type === 'charge') {
                    typeIcon = '💰';
                    typeText = '충전';
                    amountText = `${parseInt(transaction.chargeAmount).toLocaleString()}원`;
                    rateText = '';
                    resultText = '현금 충전';
                    resultColor = '#6c757d';
                } else if (transaction.type === 'convert') {
                    typeIcon = '🔄';
                    typeText = '전환';
                    amountText = `${transaction.mesoAmount}억 메소`;
                    rateText = `${transaction.mepoRate.toLocaleString()}원/1억`;
                    resultText = `${parseInt(transaction.convertCost).toLocaleString()}원 지출`;
                    resultColor = '#ffc107';
                } else if (transaction.type === 'sell') {
                    typeIcon = '💸';
                    typeText = '판매';
                    amountText = `${transaction.sellMeso}억 메소`;
                    rateText = `${transaction.waterRate.toLocaleString()}원/1억`;
                    resultText = `${parseInt(transaction.salesAmount).toLocaleString()}원 수입`;
                    resultColor = '#28a745';
                }
                
                transactionItem.innerHTML = `
                    <div class="transaction-header">
                        <div class="transaction-type">
                            <span class="type-icon">${typeIcon}</span>
                            <span class="type-text">${typeText}</span>
                        </div>
                        <div class="transaction-date">${transaction.date}</div>
                        <button onclick="deleteTransaction(${transaction.id})" class="delete-btn">삭제</button>
                    </div>
                    <div class="transaction-details">
                        <div class="detail-item">
                            <span class="detail-label">금액/메소:</span>
                            <span class="detail-value">${amountText}</span>
                        </div>
                        ${rateText ? `
                        <div class="detail-item">
                            <span class="detail-label">시세:</span>
                            <span class="detail-value">${rateText}</span>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <span class="detail-label">결과:</span>
                            <span class="detail-value" style="color: ${resultColor}">${resultText}</span>
                        </div>
                        ${transaction.memo ? `
                        <div class="detail-item">
                            <span class="detail-label">메모:</span>
                            <span class="detail-value">${transaction.memo}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(transactionItem);
            });
        }

        // 거래 삭제
        async function deleteTransaction(id) {
            if (confirm('정말 삭제하시겠습니까?')) {
                try {
                    console.log('삭제 전 거래 목록:', transactions);
                    console.log('삭제할 ID:', id, '타입:', typeof id);
                    
                    // ID 타입 통일 (문자열로 변환)
                    const targetId = String(id);
                    
                    // 로컬에서 삭제
                    const beforeCount = transactions.length;
                    transactions = transactions.filter(t => String(t.id) !== targetId);
                    const afterCount = transactions.length;
                    
                    console.log('삭제 전 개수:', beforeCount, '삭제 후 개수:', afterCount);
                    
                    // 로컬 스토리지에 저장
                    localStorage.setItem('ms-transactions', JSON.stringify(transactions));
                    
                    // 대시보드 업데이트
                    updateDashboard();
                    
                    console.log('삭제 완료:', id);
                    alert('거래가 삭제되었습니다!');
                } catch (error) {
                    console.error('삭제 실패:', error);
                    alert('삭제 중 오류가 발생했습니다.');
                }
            }
        }
    </script>
</body>
</html>

