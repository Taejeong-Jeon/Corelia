<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corelia - AI í•µì‹¬, ê³ ê¸‰ê°</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- ì¢Œì¸¡ GNB ë©”ë‰´ -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="/Corelia/" class="logo-link" onclick="showSection('main'); updateURL(''); return false;">
                    <h1 class="logo">Corelia</h1>
                    <p class="logo-subtitle">Core + Intelligence</p>
                </a>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/Corelia/AI" class="nav-link" onclick="showSection('ai-tools'); toggleSubmenu('ai-tools'); updateURL('AI'); return false;">
                        <span class="nav-icon">ğŸ¤–</span>
                        AI í™œìš©í•˜ê¸°
                        <span class="submenu-arrow">â–¼</span>
                    </a>
                    <ul class="submenu" id="ai-tools-submenu">
                        <li><a href="https://chatgpt.com/g/g-p-68a81e622c848191bfc6f52f5da56531-sosyeol/project" target="_blank">ì†Œì„¤ ë§Œë“¤ê¸°</a></li>
                        <li><a href="https://chatgpt.com/g/g-p-68da5f78b28c8191a99187e27d7add48-jemogbbobgi-jeongcaegboan-tstory/project" target="_blank">Tstory ë¸”ë¡œê·¸ ì œëª© ë½‘ê¸°</a></li>
                        <li><a href="https://chatgpt.com/g/g-p-68da5e9cd36c8191b830e4f224cc3d13-naeyongmandeulgi-jeongcaegboan-tstory/project" target="_blank">Tstory ë¸”ë¡œê·¸ ë‚´ìš© ë§Œë“¤ê¸°</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('ms'); toggleSubmenu('ms'); updateURL('MS'); return false;">
                        <span class="nav-icon">ğŸ®</span>
                        MS
                        <span class="submenu-arrow">â–¼</span>
                    </a>
                    <ul class="submenu" id="ms-submenu">
                        <li><a href="#" onclick="showSection('ms-account'); updateURL('MS-ACCOUNT'); return false;">MS ê°€ê³„ë¶€</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <main class="main-content">
            <div class="content-header">
                <h2 id="page-title">Corelia</h2>
                <p id="page-subtitle">Core + Intelligence</p>
            </div>

            <!-- ë©”ì¸ í™”ë©´ -->
            <div class="content-body" id="main">
                <div class="main-welcome">
                    <div class="main-logo">
                        <h1>Corelia</h1>
                        <p>Core + Intelligence</p>
                    </div>
                </div>
            </div>

            <!-- AI í™œìš©í•˜ê¸° í™”ë©´ -->
            <div class="content-body hidden" id="ai-tools">
                <div class="ai-tools-grid">
                    <div class="tool-card">
                        <div class="tool-icon">ğŸ“š</div>
                        <h4>ì†Œì„¤ ë§Œë“¤ê¸°</h4>
                        <p>ì°½ì˜ì ì¸ ì†Œì„¤ì„ AIì™€ í•¨ê»˜ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
                        <a href="https://chatgpt.com/g/g-p-68a81e622c848191bfc6f52f5da56531-sosyeol/project" target="_blank" class="tool-btn">ì‹œì‘í•˜ê¸°</a>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">ğŸ“</div>
                        <h4>Tstory ë¸”ë¡œê·¸ ì œëª© ë½‘ê¸°</h4>
                        <p>ë§¤ë ¥ì ì¸ ë¸”ë¡œê·¸ ì œëª©ì„ AIê°€ ì œì•ˆí•´ë“œë¦½ë‹ˆë‹¤</p>
                        <a href="https://chatgpt.com/g/g-p-68da5f78b28c8191a99187e27d7add48-jemogbbobgi-jeongcaegboan-tstory/project" target="_blank" class="tool-btn">ì‹œì‘í•˜ê¸°</a>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">âœï¸</div>
                        <h4>Tstory ë¸”ë¡œê·¸ ë‚´ìš© ë§Œë“¤ê¸°</h4>
                        <p>ê³ í’ˆì§ˆ ë¸”ë¡œê·¸ ì½˜í…ì¸ ë¥¼ AIì™€ í•¨ê»˜ ì‘ì„±í•˜ì„¸ìš”</p>
                        <a href="https://chatgpt.com/g/g-p-68da5e9cd36c8191b830e4f224cc3d13-naeyongmandeulgi-jeongcaegboan-tstory/project" target="_blank" class="tool-btn">ì‹œì‘í•˜ê¸°</a>
                    </div>
                </div>
            </div>

            <div class="content-body hidden" id="ms">
                <div class="welcome-section">
                    <h3>MS ì„¹ì…˜</h3>
                    <p>ê²Œì„ ê´€ë ¨ ì½˜í…ì¸ ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</p>
                </div>
            </div>

            <!-- MS í™ˆ ì„¹ì…˜ -->
            <div class="content-body hidden" id="ms">
                <div class="ai-tools-grid">
                    <div class="tool-card">
                        <div class="tool-icon">ğŸ’°</div>
                        <h4>MS ê°€ê³„ë¶€</h4>
                        <p>ë©”ì´í”ŒìŠ¤í† ë¦¬ ìˆ˜ìµê³¼ ì§€ì¶œì„ ê´€ë¦¬í•˜ê³  ì›”ë³„ í†µê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                        <button class="tool-btn" onclick="showSection('ms-account'); updateURL('MS-ACCOUNT'); return false;">ì‹œì‘í•˜ê¸°</button>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">ğŸ“Š</div>
                        <h4>MS í†µê³„</h4>
                        <p>ë©”ì´í”ŒìŠ¤í† ë¦¬ ê±°ë˜ í†µê³„ì™€ ìˆ˜ìµ ë¶„ì„ì„ í™•ì¸í•˜ì„¸ìš”</p>
                        <button class="tool-btn" onclick="alert('ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!')">ì‹œì‘í•˜ê¸°</button>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">ğŸ¯</div>
                        <h4>MS ëª©í‘œ</h4>
                        <p>ìˆ˜ìµ ëª©í‘œ ì„¤ì •ê³¼ ë‹¬ì„± í˜„í™©ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
                        <button class="tool-btn" onclick="alert('ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!')">ì‹œì‘í•˜ê¸°</button>
                    </div>
                </div>
            </div>

            <!-- MS ê°€ê³„ë¶€ ì„¹ì…˜ -->
            <div class="content-body hidden" id="ms-account">
                
                <!-- ì—°ê°„ ìˆ˜ìµ ê·¸ë˜í”„ -->
                <div class="annual-chart-section">
                    <h3>ì—°ê°„ ìˆ˜ìµ í˜„í™©</h3>
                    <div class="chart-container">
                        <canvas id="annualChart" width="800" height="300"></canvas>
                    </div>
                </div>

                <!-- ì›”ë³„ ëŒ€ì‹œë³´ë“œ -->
                <div class="dashboard-section">
                    <div class="month-selector">
                        <button onclick="changeMonth(-1)" class="month-btn">â—€</button>
                        <h2 id="current-month">2025ë…„ 10ì›”</h2>
                        <button onclick="changeMonth(1)" class="month-btn">â–¶</button>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="dashboard-card">
                            <h4>ì´ ì¶©ì „ê¸ˆì•¡</h4>
                            <p id="total-charge">0ì›</p>
                        </div>
                        <div class="dashboard-card">
                            <h4>ì´ íŒë§¤ê¸ˆì•¡</h4>
                            <p id="total-sales">0ì›</p>
                        </div>
                        <div class="dashboard-card">
                            <h4>ì†ìµ</h4>
                            <p id="profit-loss">0ì›</p>
                        </div>
                    </div>
                </div>

                <!-- ê±°ë˜ ì…ë ¥ í¼ -->
                <div class="form-section">
                    <h3>ê±°ë˜ ì…ë ¥</h3>
                    <form id="transaction-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>ì¼ì</label>
                                <input type="date" id="transaction-date" required>
                            </div>
                            <div class="form-group">
                                <label>ê±°ë˜ ìœ í˜•</label>
                                <select id="transaction-type" required onchange="toggleFields()">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="charge">ì¶©ì „</option>
                                    <option value="convert">ì „í™˜</option>
                                    <option value="sell">íŒë§¤</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ì¶©ì „ í•„ë“œ -->
                        <div id="charge-fields" class="transaction-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ì¶©ì „ ê¸ˆì•¡ (ì›)</label>
                                    <input type="number" id="charge-amount" placeholder="ì˜ˆ: 500000">
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì „í™˜ í•„ë“œ -->
                        <div id="convert-fields" class="transaction-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ë©”í¬ ì‹œì„¸ (ì›/1ì–µ)</label>
                                    <input type="number" id="mepo-rate" placeholder="ì˜ˆ: 2500">
                                </div>
                                <div class="form-group">
                                    <label>êµ¬ë§¤í•œ ë©”ì†Œ (ì–µ)</label>
                                    <input type="number" id="meso-amount" placeholder="ì˜ˆ: 200" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- íŒë§¤ í•„ë“œ -->
                        <div id="sell-fields" class="transaction-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ë¬¼í†µ ì‹œì„¸ (ì›/1ì–µ)</label>
                                    <input type="number" id="water-rate" placeholder="ì˜ˆ: 2000">
                                </div>
                                <div class="form-group">
                                    <label>íŒë§¤í•œ ë©”ì†Œ (ì–µ)</label>
                                    <input type="number" id="sell-meso" placeholder="ì˜ˆ: 200" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ë©”ëª¨</label>
                                <input type="text" id="memo" placeholder="ì„ íƒì‚¬í•­">
                            </div>
                        </div>
                        <button type="submit" class="submit-btn">ì €ì¥</button>
                    </form>
                </div>

                <!-- ê±°ë˜ ë‚´ì—­ -->
                <div class="transaction-list">
                    <h3>ê±°ë˜ ë‚´ì—­</h3>
                    <div id="transaction-list-container">
                        <!-- ê±°ë˜ ë‚´ì—­ì´ ì—¬ê¸°ì— ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // URL ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateURL(path) {
            // ë¡œì»¬ íŒŒì¼ì¸ì§€ í™•ì¸
            if (window.location.protocol === 'file:') {
                // ë¡œì»¬ì—ì„œëŠ” hash ì‚¬ìš©
                window.location.hash = path;
            } else {
                // ì˜¨ë¼ì¸ì—ì„œëŠ” path ì‚¬ìš©
                const baseUrl = window.location.origin + '/Corelia/';
                const newUrl = baseUrl + path;
                window.history.pushState({path: path}, '', newUrl);
            }
        }

        // URLì—ì„œ ì„¹ì…˜ ì½ê¸°
        function getSectionFromURL() {
            // ë¡œì»¬ íŒŒì¼ì¸ì§€ í™•ì¸
            if (window.location.protocol === 'file:') {
                // ë¡œì»¬ì—ì„œëŠ” hash ì‚¬ìš©
                const hash = window.location.hash;
                if (hash === '#AI') return 'ai-tools';
                if (hash === '#MS') return 'ms';
                if (hash === '#MS-ACCOUNT') return 'ms-account';
                return 'main';
            } else {
                // ì˜¨ë¼ì¸ì—ì„œëŠ” path ì‚¬ìš©
                const path = window.location.pathname;
                if (path.includes('/AI')) return 'ai-tools';
                if (path.includes('/MS-ACCOUNT')) return 'ms-account';
                if (path.includes('/MS')) return 'ms';
                return 'main';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ URLì— ë”°ë¼ ì„¹ì…˜ ì„¤ì •
        function initializePage() {
            const sectionId = getSectionFromURL();
            showSection(sectionId);
            
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™” ìƒíƒœ ì„¤ì •
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // í•´ë‹¹ ì„¹ì…˜ì˜ ë§í¬ í™œì„±í™”
            if (sectionId === 'ai-tools') {
                const aiLink = document.querySelector('a[href="/Corelia/AI"]');
                if (aiLink) {
                    aiLink.classList.add('active');
                    // AI ì„œë¸Œë©”ë‰´ ì—´ê¸°
                    const submenu = document.getElementById('ai-tools-submenu');
                    const arrow = aiLink.querySelector('.submenu-arrow');
                    if (submenu && arrow) {
                        submenu.classList.add('active');
                        arrow.textContent = 'â–²';
                    }
                }
            } else if (sectionId === 'ms') {
                const msLink = document.querySelector('a[onclick*="ms"]');
                if (msLink) {
                    msLink.classList.add('active');
                    // MS ì„œë¸Œë©”ë‰´ ì—´ê¸°
                    const submenu = document.getElementById('ms-submenu');
                    const arrow = msLink.querySelector('.submenu-arrow');
                    if (submenu && arrow) {
                        submenu.classList.add('active');
                        arrow.textContent = 'â–²';
                    }
                }
            } else if (sectionId === 'ms-account') {
                const msLink = document.querySelector('a[onclick*="ms"]');
                if (msLink) {
                    msLink.classList.add('active');
                    // MS ì„œë¸Œë©”ë‰´ ì—´ê¸°
                    const submenu = document.getElementById('ms-submenu');
                    const arrow = msLink.querySelector('.submenu-arrow');
                    if (submenu && arrow) {
                        submenu.classList.add('active');
                        arrow.textContent = 'â–²';
                    }
                }
            }
        }

        function showSection(sectionId, event) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const sections = document.querySelectorAll('.content-body');
            sections.forEach(section => section.classList.add('hidden'));
            
            // ì„ íƒëœ ì„¹ì…˜ ë³´ì´ê¸°
            document.getElementById(sectionId).classList.remove('hidden');
            
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // í˜„ì¬ í´ë¦­ëœ ë§í¬ í™œì„±í™” (eventê°€ ìˆì„ ë•Œë§Œ)
            if (event && event.currentTarget && event.currentTarget.classList) {
                event.currentTarget.classList.add('active');
            }
            
            // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
            const titles = {
                'main': { title: 'Corelia', subtitle: 'Core + Intelligence' },
                'ai-tools': { title: 'AI í™œìš©í•˜ê¸°', subtitle: 'Coreliaì˜ AI ë„êµ¬ë“¤ì„ í™œìš©í•´ë³´ì„¸ìš”' },
                'ms': { title: 'MS', subtitle: 'ê²Œì„ ê´€ë ¨ ì½˜í…ì¸ ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤' },
                'ms-account': { title: 'MS ê°€ê³„ë¶€', subtitle: 'ë©”ì´í”ŒìŠ¤í† ë¦¬ ìˆ˜ìµ ê´€ë¦¬ ì‹œìŠ¤í…œ' }
            };
            
            document.getElementById('page-title').textContent = titles[sectionId].title;
            document.getElementById('page-subtitle').textContent = titles[sectionId].subtitle;
        }

        function toggleSubmenu(menuId) {
            const submenu = document.getElementById(menuId + '-submenu');
            const navLink = event.currentTarget;
            const arrow = navLink.querySelector('.submenu-arrow');
            
            if (submenu && arrow) {
                if (submenu.classList.contains('active')) {
                    submenu.classList.remove('active');
                    arrow.textContent = 'â–¼';
                } else {
                    // ë‹¤ë¥¸ ì„œë¸Œë©”ë‰´ë“¤ ë‹«ê¸°
                    document.querySelectorAll('.submenu').forEach(menu => {
                        menu.classList.remove('active');
                    });
                    document.querySelectorAll('.submenu-arrow').forEach(arrow => {
                        arrow.textContent = 'â–¼';
                    });
                    
                    // í˜„ì¬ ì„œë¸Œë©”ë‰´ ì—´ê¸°
                    submenu.classList.add('active');
                    arrow.textContent = 'â–²';
                }
            }
        }

        // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
        window.addEventListener('popstate', function(event) {
            initializePage();
        });

        // hash ë³€ê²½ ì²˜ë¦¬ (ë¡œì»¬ íŒŒì¼ìš©)
        window.addEventListener('hashchange', function(event) {
            initializePage();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ
            const localData = localStorage.getItem('ms-transactions');
            if (localData) {
                try {
                    transactions = JSON.parse(localData);
                    console.log('í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œì»¬ ë°ì´í„° ë¡œë“œ:', transactions);
                } catch (error) {
                    console.error('ë¡œì»¬ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', error);
                    transactions = [];
                }
            }
            
            initializePage();
            initializeMSAccount();
        });

        // MS ê°€ê³„ë¶€ ê´€ë ¨ ë³€ìˆ˜ë“¤
        let currentYear = 2025;
        let currentMonth = 10;
        let transactions = [];
        const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbx-sk4f9HHx-iXgCHeDhyt8HzHAKULQxA8akZx9VqJmGj6ZDkPNpgDcQ4FCr8FASlcP/exec';

        // ê±°ë˜ ìœ í˜•ì— ë”°ë¥¸ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        function toggleFields() {
            const transactionType = document.getElementById('transaction-type').value;
            
            // ëª¨ë“  í•„ë“œ ìˆ¨ê¸°ê¸°
            document.getElementById('charge-fields').style.display = 'none';
            document.getElementById('convert-fields').style.display = 'none';
            document.getElementById('sell-fields').style.display = 'none';
            
            // ì„ íƒëœ ìœ í˜•ì— ë”°ë¼ í•„ë“œ í‘œì‹œ
            if (transactionType === 'charge') {
                document.getElementById('charge-fields').style.display = 'block';
                document.getElementById('charge-amount').required = true;
            } else if (transactionType === 'convert') {
                document.getElementById('convert-fields').style.display = 'block';
                document.getElementById('mepo-rate').required = true;
                document.getElementById('meso-amount').required = true;
            } else if (transactionType === 'sell') {
                document.getElementById('sell-fields').style.display = 'block';
                document.getElementById('water-rate').required = true;
                document.getElementById('sell-meso').required = true;
            }
            
            // ë‹¤ë¥¸ í•„ë“œë“¤ì˜ required í•´ì œ
            document.getElementById('charge-amount').required = false;
            document.getElementById('mepo-rate').required = false;
            document.getElementById('meso-amount').required = false;
            document.getElementById('water-rate').required = false;
            document.getElementById('sell-meso').required = false;
        }

        // ì—°ê°„ ìˆ˜ìµ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        function drawAnnualChart() {
            const canvas = document.getElementById('annualChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            ctx.clearRect(0, 0, width, height);
            
            // ì—°ê°„ ë°ì´í„° ê³„ì‚°
            const currentYear = new Date().getFullYear();
            const monthlyData = [];
            
            for (let month = 1; month <= 12; month++) {
                const monthTransactions = transactions.filter(t => {
                    const date = new Date(t.date);
                    return date.getFullYear() === currentYear && date.getMonth() + 1 === month;
                });
                
                const totalCharge = monthTransactions
                    .filter(t => t.type === 'charge')
                    .reduce((sum, t) => sum + (parseInt(t.chargeAmount) || 0), 0);
                
                const totalSales = monthTransactions
                    .filter(t => t.type === 'sell')
                    .reduce((sum, t) => sum + (parseInt(t.salesAmount) || 0), 0);
                
                const profitLoss = totalSales - totalCharge;
                monthlyData.push(profitLoss);
            }
            
            // ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
            const margin = 60;
            const chartWidth = width - 2 * margin;
            const chartHeight = height - 2 * margin;
            
            // ë°°ê²½ ê·¸ë¦¬ê¸°
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(margin, margin, chartWidth, chartHeight);
            
            // ê²©ì ê·¸ë¦¬ê¸°
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 1;
            
            // ìˆ˜í‰ ê²©ì
            for (let i = 0; i <= 10; i++) {
                const y = margin + (chartHeight / 10) * i;
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(margin + chartWidth, y);
                ctx.stroke();
            }
            
            // ìˆ˜ì§ ê²©ì
            for (let i = 0; i <= 12; i++) {
                const x = margin + (chartWidth / 12) * i;
                ctx.beginPath();
                ctx.moveTo(x, margin);
                ctx.lineTo(x, margin + chartHeight);
                ctx.stroke();
            }
            
            // 0ì„  ê·¸ë¦¬ê¸°
            const zeroY = margin + chartHeight / 2;
            ctx.strokeStyle = '#6c757d';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, zeroY);
            ctx.lineTo(margin + chartWidth, zeroY);
            ctx.stroke();
            
            // ë°ì´í„° í¬ì¸íŠ¸ ê·¸ë¦¬ê¸°
            const maxValue = Math.max(...monthlyData.map(Math.abs));
            const scale = maxValue > 0 ? (chartHeight / 2) / maxValue : 1;
            
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            monthlyData.forEach((value, index) => {
                const x = margin + (chartWidth / 12) * (index + 0.5);
                const y = zeroY - (value * scale);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // í¬ì¸íŠ¸ ê·¸ë¦¬ê¸°
                ctx.fillStyle = value >= 0 ? '#28a745' : '#dc3545';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            ctx.stroke();
            
            // ì›” ë¼ë²¨ ê·¸ë¦¬ê¸°
            ctx.fillStyle = '#6c757d';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            for (let i = 0; i < 12; i++) {
                const x = margin + (chartWidth / 12) * (i + 0.5);
                const y = height - 20;
                ctx.fillText(`${i + 1}ì›”`, x, y);
            }
            
            // Yì¶• ë¼ë²¨ ê·¸ë¦¬ê¸°
            ctx.textAlign = 'right';
            ctx.fillText('ìˆ˜ìµ', 20, margin + 10);
            ctx.fillText('ì†ì‹¤', 20, height - margin - 10);
        }

        // MS ê°€ê³„ë¶€ ì´ˆê¸°í™”
        function initializeMSAccount() {
            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            
            // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);
            
            // ë¨¼ì € ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ
            const localData = localStorage.getItem('ms-transactions');
            if (localData) {
                try {
                    transactions = JSON.parse(localData);
                    console.log('ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', transactions);
                    updateDashboard();
                } catch (error) {
                    console.error('ë¡œì»¬ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', error);
                    transactions = [];
                }
            }
            
            // Google Sheetsì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„
            loadTransactions();
        }

        // Google Sheetsì—ì„œ ê±°ë˜ ë°ì´í„° ë¡œë“œ
        async function loadTransactions() {
            try {
                console.log('ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                const response = await fetch(GOOGLE_SHEETS_API_URL);
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('ë¡œë“œëœ ë°ì´í„°:', data);
                
                // Google Sheetsì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë¡œì»¬ ë°ì´í„° ìœ ì§€
                if (data && data.length > 0) {
                    transactions = data;
                    console.log('Google Sheets ë°ì´í„° ì‚¬ìš©:', transactions);
                } else {
                    console.log('Google Sheetsê°€ ë¹„ì–´ìˆìŒ, ë¡œì»¬ ë°ì´í„° ìœ ì§€');
                }
                updateDashboard();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„
                const localData = localStorage.getItem('ms-transactions');
                if (localData) {
                    transactions = JSON.parse(localData);
                    console.log('ë¡œì»¬ ë°ì´í„° ë¡œë“œ:', transactions);
                }
                updateDashboard();
            }
        }

        // Google Sheetsì— ê±°ë˜ ë°ì´í„° ì €ì¥
        async function saveTransaction(transaction) {
            try {
                console.log('ë°ì´í„° ì €ì¥ ì‹œì‘:', transaction);
                
                const response = await fetch(GOOGLE_SHEETS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transaction)
                });
                
                console.log('ì €ì¥ ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ì €ì¥ ê²°ê³¼:', result);
                
                if (result.success) {
                    console.log('Google Sheets ì €ì¥ ì„±ê³µ');
                    // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                    await loadTransactions();
                } else {
                    throw new Error('ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Google Sheets ì €ì¥ ì‹¤íŒ¨:', error);
                console.log('ë¡œì»¬ ì €ì¥ìœ¼ë¡œ ëŒ€ì²´...');
                
                // ë¡œì»¬ì— ì €ì¥ (ë°±ì—…)
                const newTransaction = {
                    ...transaction,
                    id: Date.now().toString()
                };
                transactions.push(newTransaction);
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥
                localStorage.setItem('ms-transactions', JSON.stringify(transactions));
                
                updateDashboard();
                alert('ë°ì´í„°ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (Google Sheets ì—°ê²° ì‹¤íŒ¨)');
            }
        }

        // ì›” ë³€ê²½ í•¨ìˆ˜
        function changeMonth(direction) {
            currentMonth += direction;
            
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            // 2030ë…„ 12ì›” ì œí•œ
            if (currentYear > 2030 || (currentYear === 2030 && currentMonth > 12)) {
                currentYear = 2030;
                currentMonth = 12;
            }
            
            // 2025ë…„ 10ì›” ì œí•œ
            if (currentYear < 2025 || (currentYear === 2025 && currentMonth < 10)) {
                currentYear = 2025;
                currentMonth = 10;
            }
            
            updateMonthDisplay();
            updateDashboard();
        }

        // ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateMonthDisplay() {
            document.getElementById('current-month').textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard() {
            const monthTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === currentYear && date.getMonth() + 1 === currentMonth;
            });
            
            // ì¶©ì „ ì´ì•¡ (ì§€ì¶œì´ë¯€ë¡œ ë§ˆì´ë„ˆìŠ¤)
            const totalCharge = monthTransactions
                .filter(t => t.type === 'charge')
                .reduce((sum, t) => sum + (parseInt(t.chargeAmount) || 0), 0);
            
            // íŒë§¤ ì´ ê¸ˆì•¡ (ìˆ˜ì…ì´ë¯€ë¡œ í”ŒëŸ¬ìŠ¤)
            const totalSales = monthTransactions
                .filter(t => t.type === 'sell')
                .reduce((sum, t) => sum + (parseInt(t.salesAmount) || 0), 0);
            
            // ì†ìµ ê³„ì‚°: íŒë§¤ê¸ˆì•¡(+) - ì¶©ì „ê¸ˆì•¡(-)
            // ì „í™˜ì€ ë©”ì†Œ êµ¬ë§¤/ë³´ê´€ì´ë¯€ë¡œ ì†ìµì— ì˜í–¥ ì—†ìŒ
            const profitLoss = totalSales - totalCharge;
            
            document.getElementById('total-charge').textContent = `${totalCharge.toLocaleString()}ì›`;
            document.getElementById('total-sales').textContent = `${totalSales.toLocaleString()}ì›`;
            
            const profitLossElement = document.getElementById('profit-loss');
            profitLossElement.textContent = `${profitLoss.toLocaleString()}ì›`;
            
            // ì†ìµì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
            if (profitLoss > 0) {
                profitLossElement.style.color = '#007bff'; // íŒŒë€ìƒ‰ (ìˆ˜ìµ)
            } else if (profitLoss < 0) {
                profitLossElement.style.color = '#dc3545'; // ë¹¨ê°„ìƒ‰ (ì†í•´)
            } else {
                profitLossElement.style.color = '#6c757d'; // íšŒìƒ‰ (ì†ìµ ì—†ìŒ)
            }
            
            updateTransactionTable();
            drawAnnualChart();
        }

        // ê±°ë˜ ì œì¶œ ì²˜ë¦¬
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            
            const transactionType = document.getElementById('transaction-type').value;
            const date = document.getElementById('transaction-date').value;
            const memo = document.getElementById('memo').value || '';
            
            let transaction = {
                id: Date.now().toString(),
                date: date,
                type: transactionType,
                memo: memo
            };
            
            if (transactionType === 'charge') {
                // ì¶©ì „: ì¼ì + ì¶©ì „ê¸ˆì•¡ë§Œ
                transaction.chargeAmount = parseInt(document.getElementById('charge-amount').value);
                
            } else if (transactionType === 'convert') {
                // ì „í™˜: ë©”í¬ì‹œì„¸ + êµ¬ë§¤í•œ ë©”ì†Œ
                transaction.mepoRate = parseInt(document.getElementById('mepo-rate').value);
                transaction.mesoAmount = parseFloat(document.getElementById('meso-amount').value);
                transaction.convertCost = transaction.mepoRate * transaction.mesoAmount; // ì „í™˜ ë¹„ìš©
                
            } else if (transactionType === 'sell') {
                // íŒë§¤: ë¬¼í†µì‹œì„¸ + íŒë§¤í•œ ë©”ì†Œ
                transaction.waterRate = parseInt(document.getElementById('water-rate').value);
                transaction.sellMeso = parseFloat(document.getElementById('sell-meso').value);
                transaction.salesAmount = transaction.waterRate * transaction.sellMeso; // íŒë§¤ ê¸ˆì•¡
            }
            
            // Google Sheetsì— ì €ì¥ ì‹œë„ (ì‹¤íŒ¨ ì‹œ ë¡œì»¬ì— ì €ì¥)
            await saveTransaction(transaction);
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
        }

        // ê±°ë˜ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateTransactionTable() {
            const container = document.getElementById('transaction-list-container');
            container.innerHTML = '';
            
            const monthTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === currentYear && date.getMonth() + 1 === currentMonth;
            });
            
            if (monthTransactions.length === 0) {
                container.innerHTML = '<div class="empty-state">ì´ë²ˆ ë‹¬ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            monthTransactions.forEach(transaction => {
                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item';
                
                let typeIcon, typeText, amountText, rateText, resultText, resultColor;
                
                if (transaction.type === 'charge') {
                    typeIcon = 'ğŸ’°';
                    typeText = 'ì¶©ì „';
                    amountText = `${parseInt(transaction.chargeAmount).toLocaleString()}ì›`;
                    rateText = '';
                    resultText = 'í˜„ê¸ˆ ì¶©ì „';
                    resultColor = '#6c757d';
                } else if (transaction.type === 'convert') {
                    typeIcon = 'ğŸ”„';
                    typeText = 'ì „í™˜';
                    amountText = `${transaction.mesoAmount}ì–µ ë©”ì†Œ`;
                    rateText = `${transaction.mepoRate.toLocaleString()}ì›/1ì–µ`;
                    resultText = `${parseInt(transaction.convertCost).toLocaleString()}ì› ì§€ì¶œ`;
                    resultColor = '#ffc107';
                } else if (transaction.type === 'sell') {
                    typeIcon = 'ğŸ’¸';
                    typeText = 'íŒë§¤';
                    amountText = `${transaction.sellMeso}ì–µ ë©”ì†Œ`;
                    rateText = `${transaction.waterRate.toLocaleString()}ì›/1ì–µ`;
                    resultText = `${parseInt(transaction.salesAmount).toLocaleString()}ì› ìˆ˜ì…`;
                    resultColor = '#28a745';
                }
                
                transactionItem.innerHTML = `
                    <div class="transaction-header">
                        <div class="transaction-type">
                            <span class="type-icon">${typeIcon}</span>
                            <span class="type-text">${typeText}</span>
                        </div>
                        <div class="transaction-date">${transaction.date}</div>
                        <button onclick="deleteTransaction(${transaction.id})" class="delete-btn">ì‚­ì œ</button>
                    </div>
                    <div class="transaction-details">
                        <div class="detail-item">
                            <span class="detail-label">ê¸ˆì•¡/ë©”ì†Œ:</span>
                            <span class="detail-value">${amountText}</span>
                        </div>
                        ${rateText ? `
                        <div class="detail-item">
                            <span class="detail-label">ì‹œì„¸:</span>
                            <span class="detail-value">${rateText}</span>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <span class="detail-label">ê²°ê³¼:</span>
                            <span class="detail-value" style="color: ${resultColor}">${resultText}</span>
                        </div>
                        ${transaction.memo ? `
                        <div class="detail-item">
                            <span class="detail-label">ë©”ëª¨:</span>
                            <span class="detail-value">${transaction.memo}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(transactionItem);
            });
        }

        // ê±°ë˜ ì‚­ì œ
        async function deleteTransaction(id) {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    console.log('ì‚­ì œ ì „ ê±°ë˜ ëª©ë¡:', transactions);
                    console.log('ì‚­ì œí•  ID:', id, 'íƒ€ì…:', typeof id);
                    
                    // ID íƒ€ì… í†µì¼ (ë¬¸ìì—´ë¡œ ë³€í™˜)
                    const targetId = String(id);
                    
                    // ë¡œì»¬ì—ì„œ ì‚­ì œ
                    const beforeCount = transactions.length;
                    transactions = transactions.filter(t => String(t.id) !== targetId);
                    const afterCount = transactions.length;
                    
                    console.log('ì‚­ì œ ì „ ê°œìˆ˜:', beforeCount, 'ì‚­ì œ í›„ ê°œìˆ˜:', afterCount);
                    
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    localStorage.setItem('ms-transactions', JSON.stringify(transactions));
                    
                    // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
                    updateDashboard();
                    
                    console.log('ì‚­ì œ ì™„ë£Œ:', id);
                    alert('ê±°ë˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (error) {
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
    </script>
</body>
</html>

